-- DATABASE --
CREATE TYPE "user_type" AS ENUM (
  'Administrator',
  'Veterinarian',
  'Assistant',
  'Client'
);
CREATE TYPE "user_status" AS ENUM ('Active', 'Inactive', 'Suspended');
CREATE TYPE "pet_gender" AS ENUM ('Male', 'Female');
CREATE TYPE "pet_status" AS ENUM ('Active', 'Inactive', 'Deceased');
CREATE TYPE "service_category" AS ENUM (
  'Consultation',
  'Surgery',
  'Treatment',
  'Grooming',
  'Vaccination',
  'Deworming'
);
CREATE TYPE "service_status" AS ENUM ('Available', 'Unavailable');
CREATE TYPE "consultation_priority" AS ENUM ('Low', 'Medium', 'High', 'Emergency');
CREATE TYPE "consultation_status" AS ENUM ('Open', 'In Progress', 'Closed');
CREATE TYPE "treatment_status" AS ENUM ('Active', 'Completed', 'Cancelled');
CREATE TYPE "inventory_type" AS ENUM (
  'Medicine',
  'Vaccine',
  'Accessory',
  'Food',
  'Other'
);
CREATE TYPE "inventory_status" AS ENUM (
  'Available',
  'Out of Stock',
  'Discontinued'
);
CREATE TYPE "surgery_type" AS ENUM (
  'Sterilization',
  'Emergency',
  'Orthopedic',
  'Dental',
  'Other'
);
CREATE TYPE "surgery_status" AS ENUM (
  'Scheduled',
  'In Progress',
  'Completed',
  'Cancelled'
);
CREATE TYPE "appointment_status" AS ENUM (
  'Pending',
  'Confirmed',
  'Cancelled',
  'Completed'
);
CREATE TABLE "roles" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" user_type NOT NULL,
  "permissions" JSON
);
CREATE TABLE "users" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "role_id" int,
  "identification_number" varchar(20),
  "first_name" varchar(100) NOT NULL,
  "last_name" varchar(100) NOT NULL,
  "date_of_birth" date,
  "phone" varchar(20),
  "address" text,
  "username" varchar(50) UNIQUE NOT NULL,
  "email" varchar(100) UNIQUE NOT NULL,
  "password" text NOT NULL,
  "profile_photo" text,
  "status" user_status DEFAULT 'Active',
  "created_at" timestamp,
  "updated_at" timestamp
);
CREATE TABLE "species" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" varchar(100) NOT NULL
);
CREATE TABLE "pets" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "owner_id" int,
  "species_id" int,
  "name" varchar(100) NOT NULL,
  "breed" varchar(100),
  "date_of_birth" date,
  "gender" pet_gender,
  "color" varchar(50),
  "status" pet_status DEFAULT 'Active',
  "created_at" timestamp,
  "updated_at" timestamp
);
CREATE TABLE "services" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" varchar(100) NOT NULL,
  "category" service_category,
  "cost" decimal(10, 2),
  "status" service_status DEFAULT 'Available'
);
CREATE TABLE "consultations" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "pet_id" int,
  "veterinarian_id" int,
  "appointment_id" int,
  "reason" text,
  "weight" float,
  "height" float,
  "priority" consultation_priority DEFAULT 'Medium',
  "diagnosis" text,
  "notes" text,
  "status" consultation_status DEFAULT 'Open',
  "created_at" timestamp,
  "updated_at" timestamp
);
CREATE TABLE "consultation_services" ("consultation_id" int, "service_id" int);
CREATE TABLE "treatments" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "pet_id" int,
  "consultation_id" int,
  "status" treatment_status DEFAULT 'Active',
  "created_at" timestamp,
  "updated_at" timestamp
);
CREATE TABLE "treatment_services" ("treatment_id" int, "service_id" int);
CREATE TABLE "inventory" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" varchar(100) NOT NULL,
  "type" inventory_type,
  "instructions" text,
  "quantity" int,
  "unit_price" decimal(10, 2),
  "status" inventory_status DEFAULT 'Available',
  "created_at" timestamp,
  "updated_at" timestamp
);
CREATE TABLE "prescriptions" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "medication_id" int,
  "dosage_instructions" text NOT NULL
);
CREATE TABLE "treatment_prescriptions" (
  "treatment_id" int,
  "prescription_id" int UNIQUE
);
CREATE TABLE "surgeries" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "pet_id" int,
  "veterinarian_id" int,
  "surgery_date" date,
  "surgery_type" surgery_type,
  "notes" text,
  "status" surgery_status DEFAULT 'Scheduled',
  "created_at" timestamp,
  "updated_at" timestamp
);
CREATE TABLE "surgery_services" ("surgery_id" int, "service_id" int);
CREATE TABLE "appointments" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "pet_id" int,
  "status" appointment_status DEFAULT 'Pending',
  "notes" text,
  "created_at" timestamp,
  "updated_at" timestamp
);
COMMENT ON TABLE "consultation_services" IS 'Composite primary key (consultation_id, service_id)';
COMMENT ON TABLE "treatment_services" IS 'Composite primary key (treatment_id, service_id)';
COMMENT ON TABLE "treatment_prescriptions" IS 'Composite primary key (treatment_id, prescription_id)';
COMMENT ON TABLE "surgery_services" IS 'Composite primary key (surgery_id, service_id)';
ALTER TABLE "users"
ADD FOREIGN KEY ("role_id") REFERENCES "roles" ("id");
ALTER TABLE "pets"
ADD FOREIGN KEY ("owner_id") REFERENCES "users" ("id");
ALTER TABLE "pets"
ADD FOREIGN KEY ("species_id") REFERENCES "species" ("id");
ALTER TABLE "consultations"
ADD FOREIGN KEY ("pet_id") REFERENCES "pets" ("id");
ALTER TABLE "consultations"
ADD FOREIGN KEY ("veterinarian_id") REFERENCES "users" ("id");
ALTER TABLE "consultation_services"
ADD FOREIGN KEY ("consultation_id") REFERENCES "consultations" ("id");
ALTER TABLE "consultation_services"
ADD FOREIGN KEY ("service_id") REFERENCES "services" ("id");
ALTER TABLE "treatments"
ADD FOREIGN KEY ("pet_id") REFERENCES "pets" ("id");
ALTER TABLE "treatments"
ADD FOREIGN KEY ("consultation_id") REFERENCES "consultations" ("id");
ALTER TABLE "treatment_services"
ADD FOREIGN KEY ("treatment_id") REFERENCES "treatments" ("id");
ALTER TABLE "treatment_services"
ADD FOREIGN KEY ("service_id") REFERENCES "services" ("id");
ALTER TABLE "prescriptions"
ADD FOREIGN KEY ("medication_id") REFERENCES "inventory" ("id");
ALTER TABLE "treatment_prescriptions"
ADD FOREIGN KEY ("treatment_id") REFERENCES "treatments" ("id");
ALTER TABLE "treatment_prescriptions"
ADD FOREIGN KEY ("prescription_id") REFERENCES "prescriptions" ("id");
ALTER TABLE "surgeries"
ADD FOREIGN KEY ("pet_id") REFERENCES "pets" ("id");
ALTER TABLE "surgeries"
ADD FOREIGN KEY ("veterinarian_id") REFERENCES "users" ("id");
ALTER TABLE "surgery_services"
ADD FOREIGN KEY ("surgery_id") REFERENCES "surgeries" ("id");
ALTER TABLE "surgery_services"
ADD FOREIGN KEY ("service_id") REFERENCES "services" ("id");
ALTER TABLE "appointments"
ADD FOREIGN KEY ("pet_id") REFERENCES "pets" ("id");

-- INSERTS --
-- ============================================
-- DATOS DE EJEMPLO PARA VETERINARIA
-- CORREGIDO: Tabla appointments no tiene veterinarian_id
-- ============================================
-- Primero, necesitamos eliminar o modificar la restricción de llave foránea problemática
-- Comenta o descomenta según tu necesidad:
-- OPCIÓN 1: Si quieres mantener la relación pero la tabla no tiene el campo
-- ALTER TABLE "appointments" DROP CONSTRAINT IF EXISTS appointments_veterinarian_id_fkey;
-- OPCIÓN 2: Si decides agregar el campo a la tabla
-- ALTER TABLE "appointments" ADD COLUMN IF NOT EXISTS "veterinarian_id" int;
-- ALTER TABLE "appointments" ADD FOREIGN KEY ("veterinarian_id") REFERENCES "users" ("id");
-- Insertar roles (SOLO UNA VEZ, elimina el segundo INSERT de roles)
INSERT INTO "roles" ("name", "permissions")
VALUES (
    'Client',
    '{"pets": ["read-own"], "users": ["own"], "consultations": ["read-own"], "treatments": ["read-own"], "prescriptions": ["read-own"], "surgeries": ["read-own"], "appointments": ["own", "only-delete-pending"]}'
  ),
  (
    'Assistant',
    '{"pets": ["all"], "users": ["all"], "consultations": ["only-write"], "inventory": ["all"], "surgeries": ["only-write"], "appointments": ["all", "only-delete-pending"]}'
  ),
  (
    'Veterinarian',
    '{"pets": ["only-read-assigned"], "consultations": ["only-read-assigned", "only-edit-assigned"], "treatments": ["only-assigned"], "prescriptions": ["only-assigned"], "surgeries": ["only-read-assigned", "only-edit-assigned"]}'
  ),
  (
    'Administrator',
    '{"pets": ["all"], "users": ["all"], "consultations": ["all"], "treatments": ["all"], "prescriptions": ["all"], "inventory": ["all"], "surgeries": ["all"], "appointments": ["all", "only-delete-pending"]}'
  );
-- Insertar especies
INSERT INTO "species" ("name")
VALUES ('Perro'),
  ('Gato'),
  ('Conejo'),
  ('Hurón'),
  ('Ave'),
  ('Hamster'),
  ('Tortuga'),
  ('Iguana'),
  ('Cobaya'),
  ('Erizo');
-- Insertar servicios
INSERT INTO "services" ("name", "category", "cost", "status")
VALUES (
    'Consulta general',
    'Consultation',
    45.00,
    'Available'
  ),
  (
    'Consulta de emergencia',
    'Consultation',
    85.00,
    'Available'
  ),
  (
    'Vacuna triple felina',
    'Vaccination',
    60.00,
    'Available'
  ),
  (
    'Vacuna antirrábica',
    'Vaccination',
    50.00,
    'Available'
  ),
  (
    'Desparasitación interna',
    'Deworming',
    30.00,
    'Available'
  ),
  (
    'Desparasitación externa',
    'Deworming',
    35.00,
    'Available'
  ),
  (
    'Castración canina',
    'Surgery',
    200.00,
    'Available'
  ),
  (
    'Castración felina',
    'Surgery',
    180.00,
    'Available'
  ),
  (
    'Limpieza dental',
    'Treatment',
    120.00,
    'Available'
  ),
  ('Corte de pelo', 'Grooming', 40.00, 'Available'),
  (
    'Baño medicinal',
    'Treatment',
    35.00,
    'Available'
  ),
  ('Radiografía', 'Treatment', 90.00, 'Available'),
  ('Ecografía', 'Treatment', 150.00, 'Available'),
  (
    'Quimioterapia',
    'Treatment',
    300.00,
    'Unavailable'
  );
-- Insertar inventario
INSERT INTO "inventory" (
    "name",
    "type",
    "instructions",
    "quantity",
    "unit_price",
    "status",
    "created_at"
  )
VALUES (
    'Amoxicilina 500mg',
    'Medicine',
    'Administrar cada 12 horas por 7 días',
    150,
    2.50,
    'Available',
    NOW()
  ),
  (
    'Ivermectina 1%',
    'Medicine',
    'Aplicar según peso del animal',
    80,
    15.00,
    'Available',
    NOW()
  ),
  (
    'Vacuna Canigen DHA2PPi',
    'Vaccine',
    'Conservar refrigerada',
    45,
    25.00,
    'Available',
    NOW()
  ),
  (
    'Vacuna Felocell 4',
    'Vaccine',
    'Conservar refrigerada',
    35,
    28.00,
    'Available',
    NOW()
  ),
  (
    'Collar antipulgas',
    'Accessory',
    'Cambiar cada 3 meses',
    120,
    18.00,
    'Available',
    NOW()
  ),
  (
    'Alimento para perros adultos',
    'Food',
    'Bolsa 15kg',
    60,
    45.00,
    'Available',
    NOW()
  ),
  (
    'Alimento para gatos castrados',
    'Food',
    'Bolsa 7kg',
    45,
    35.00,
    'Available',
    NOW()
  ),
  (
    'Jeringas estériles 5ml',
    'Other',
    'Usar y desechar',
    500,
    0.50,
    'Available',
    NOW()
  ),
  (
    'Gasas estériles',
    'Other',
    'Paquete de 100 unidades',
    40,
    8.00,
    'Available',
    NOW()
  ),
  (
    'Anestésico Isoflurano',
    'Medicine',
    'Uso exclusivo veterinario',
    20,
    120.00,
    'Available',
    NOW()
  ),
  (
    'Analgésico Meloxicam',
    'Medicine',
    'Administrar con alimento',
    95,
    1.80,
    'Available',
    NOW()
  ),
  (
    'Shampoo dermatológico',
    'Other',
    'Usar 2 veces por semana',
    25,
    22.00,
    'Available',
    NOW()
  ),
  (
    'Suero fisiológico 500ml',
    'Other',
    'Uso intravenoso',
    70,
    4.50,
    'Available',
    NOW()
  );
-- Insertar usuarios
INSERT INTO "users" (
    "role_id",
    "identification_number",
    "first_name",
    "last_name",
    "date_of_birth",
    "phone",
    "address",
    "username",
    "email",
    "password",
    "status",
    "created_at"
  )
VALUES (
    4,
    'V-31098509',
    'david',
    'parra',
    '2004-08-06',
    '+584247232981',
    'Av. Principal #123, Tachira',
    'dey',
    'david@gmail.com',
    'david123',
    'Active',
    NOW()
  ),
  (
    4,
    'V-30000000',
    'freily',
    'r',
    '2000-01-01',
    '+584248974871',
    'Av. Principal #123, Tachira',
    'freily',
    'freily@gmail.com',
    'freily123',
    'Active',
    NOW()
  ),
  (
    3,
    'V-23456789',
    'Carlos',
    'Rodríguez',
    '1979-07-22',
    '+584142345678',
    'Calle 10 #45-67, Valencia',
    'crodriguez',
    'carlos.rodriguez@vetcare.com',
    'hashed_password_2',
    'Active',
    NOW()
  ),
  (
    2,
    'V-34567890',
    'Ana',
    'Martínez',
    '1990-11-30',
    '+584143456789',
    'Urbanización Las Acacias, Maracaibo',
    'amartinez',
    'ana.martinez@vetcare.com',
    'hashed_password_3',
    'Active',
    NOW()
  ),
  (
    2,
    'V-45678901',
    'Pedro',
    'López',
    '1988-05-18',
    '+584144567890',
    'Sector El Paraíso, Barquisimeto',
    'plopez',
    'pedro.lopez@vetcare.com',
    'hashed_password_4',
    'Active',
    NOW()
  ),
  (
    1,
    'V-56789012',
    'Laura',
    'Pérez',
    '1975-09-05',
    '+584145678901',
    'Residencias La Floresta, Caracas',
    'lperez',
    'laura.perez@vetcare.com',
    'hashed_password_5',
    'Active',
    NOW()
  ),
  (
    3,
    'V-67890123',
    'Juan',
    'Ramírez',
    '1982-01-25',
    '+584146789012',
    'Calle Los Manguitos, Maracay',
    'jramirez',
    'juan.ramirez@gmail.com',
    'hashed_password_6',
    'Active',
    NOW()
  ),
  (
    1,
    'V-78901234',
    'Carmen',
    'Hernández',
    '1993-12-08',
    '+584147890123',
    'Avenida Circunvalación, Puerto Ordaz',
    'chernandez',
    'carmen.hernandez@gmail.com',
    'hashed_password_7',
    'Active',
    NOW()
  ),
  (
    2,
    'V-89012345',
    'Roberto',
    'Díaz',
    '1968-04-17',
    '+584148901234',
    'Urbanización Santa Fe, Valencia',
    'rdiaz',
    'roberto.diaz@gmail.com',
    'hashed_password_8',
    'Active',
    NOW()
  ),
  (
    3,
    'V-90123456',
    'Sofía',
    'Morales',
    '1995-08-23',
    '+584149012345',
    'Sector La Victoria, Barinas',
    'smorales',
    'sofia.morales@gmail.com',
    'hashed_password_9',
    'Active',
    NOW()
  ),
  (
    2,
    'V-01234567',
    'Luis',
    'Torres',
    '1980-06-11',
    '+584140123456',
    'Residencias Los Naranjos, Mérida',
    'ltorres',
    'luis.torres@gmail.com',
    'hashed_password_10',
    'Active',
    NOW()
  );
-- Insertar mascotas
INSERT INTO "pets" (
    "owner_id",
    "species_id",
    "name",
    "breed",
    "date_of_birth",
    "gender",
    "color",
    "status",
    "created_at"
  )
VALUES (
    3,
    1,
    'Max',
    'Labrador Retriever',
    '2020-04-10',
    'Male',
    'Amarillo',
    'Active',
    NOW()
  ),
  (
    3,
    1,
    'Luna',
    'French Poodle',
    '2021-08-15',
    'Female',
    'Blanco',
    'Active',
    NOW()
  ),
  (
    4,
    2,
    'Simba',
    'Persa',
    '2019-11-20',
    'Male',
    'Naranja',
    'Active',
    NOW()
  ),
  (
    4,
    2,
    'Nala',
    'Siamés',
    '2022-01-30',
    'Female',
    'Crema con puntos marrones',
    'Active',
    NOW()
  ),
  (
    5,
    1,
    'Rocky',
    'Bulldog Francés',
    '2020-12-05',
    'Male',
    'Atigrado',
    'Active',
    NOW()
  ),
  (
    5,
    3,
    'Copo',
    'Angora',
    '2021-03-22',
    'Male',
    'Blanco',
    'Active',
    NOW()
  ),
  (
    6,
    4,
    'Fiona',
    'Hurón estándar',
    '2022-06-18',
    'Female',
    'Sable',
    'Active',
    NOW()
  ),
  (
    6,
    2,
    'Michi',
    'Mestizo',
    '2018-07-12',
    'Male',
    'Negro',
    'Active',
    NOW()
  ),
  (
    7,
    1,
    'Thor',
    'Pastor Alemán',
    '2019-02-28',
    'Male',
    'Negro y café',
    'Active',
    NOW()
  ),
  (
    7,
    5,
    'Piolín',
    'Canario',
    '2021-10-14',
    'Male',
    'Amarillo',
    'Active',
    NOW()
  );
-- Primero insertar citas (NOTA: appointments no tiene veterinarian_id en la estructura actual)
INSERT INTO "appointments" ("pet_id", "status", "notes", "created_at")
VALUES (2, 'Confirmed', 'Control de peso', NOW()),
  (8, 'Pending', 'Vacunación anual', NOW()),
  (10, 'Confirmed', 'Revisión general', NOW()),
  (1, 'Confirmed', 'Control post-operatorio', NOW()),
  (3, 'Pending', 'Seguimiento respiratorio', NOW());
-- Insertar consultas
INSERT INTO "consultations" (
    "pet_id",
    "veterinarian_id",
    "appointment_id",
    "reason",
    "weight",
    "height",
    "priority",
    "diagnosis",
    "notes",
    "status",
    "created_at"
  )
VALUES (
    1,
    3,
    NULL,
    'Control anual y vacunación',
    28.5,
    55.0,
    'Low',
    'Salud óptima',
    'Se aplicó vacuna antirrábica',
    'Closed',
    '2024-01-15 09:30:00'
  ),
  (
    3,
    4,
    NULL,
    'Inapetencia y letargo',
    5.8,
    25.0,
    'Medium',
    'Infección respiratoria superior',
    'Tratamiento con antibióticos por 10 días',
    'Closed',
    '2024-01-20 14:15:00'
  ),
  (
    5,
    3,
    NULL,
    'Cojeando pata delantera derecha',
    12.0,
    30.0,
    'High',
    'Esguince grado 1',
    'Reposo y antiinflamatorios',
    'In Progress',
    '2024-02-05 11:00:00'
  ),
  (
    2,
    4,
    1,
    'Desparasitación rutinaria',
    6.2,
    35.0,
    'Low',
    'Parasitosis leve',
    'Desparasitación interna y externa',
    'Closed',
    '2024-02-10 10:00:00'
  ),
  (
    7,
    3,
    NULL,
    'Pérdida de peso',
    1.2,
    15.0,
    'Medium',
    'Problemas digestivos',
    'Cambio de dieta recomendado',
    'Open',
    '2024-02-12 16:45:00'
  ),
  (
    9,
    4,
    NULL,
    'Control post-operatorio',
    34.0,
    60.0,
    'Low',
    'Recuperación satisfactoria',
    'Suturas en buen estado',
    'Closed',
    '2024-02-14 08:30:00'
  ),
  (
    4,
    3,
    NULL,
    'Estornudos frecuentes',
    3.5,
    20.0,
    'Medium',
    'Alergia estacional',
    'Antihistamínico recomendado',
    'In Progress',
    '2024-02-15 13:20:00'
  );
-- Insertar servicios en consultas
INSERT INTO "consultation_services" ("consultation_id", "service_id")
VALUES (1, 1),
  (1, 4),
  (2, 1),
  (3, 1),
  (3, 12),
  (4, 1),
  (4, 5),
  (4, 6),
  (5, 1),
  (6, 1),
  (7, 1),
  (7, 2);
-- Insertar tratamientos
INSERT INTO "treatments" (
    "pet_id",
    "consultation_id",
    "status",
    "created_at"
  )
VALUES (3, 2, 'Completed', '2024-01-20'),
  (5, 3, 'Active', '2024-02-05'),
  (4, 7, 'Active', '2024-02-15');
-- Insertar servicios en tratamientos
INSERT INTO "treatment_services" ("treatment_id", "service_id")
VALUES (1, 1),
  (2, 1),
  (2, 12),
  (3, 1);
-- Insertar prescripciones
INSERT INTO "prescriptions" ("medication_id", "dosage_instructions")
VALUES (1, '1 tableta cada 12 horas durante 10 días'),
  (
    11,
    '0.5 mg por kg de peso cada 24 horas por 5 días'
  ),
  (1, '1 tableta cada 24 horas durante 7 días'),
  (2, 'Aplicar 0.5 ml por vía subcutánea');
-- Insertar relación tratamiento-prescripción
INSERT INTO "treatment_prescriptions" ("treatment_id", "prescription_id")
VALUES (1, 1),
  (2, 2),
  (3, 3);
-- Insertar cirugías
INSERT INTO "surgeries" (
    "pet_id",
    "veterinarian_id",
    "surgery_date",
    "surgery_type",
    "notes",
    "status",
    "created_at"
  )
VALUES (
    9,
    3,
    '2024-02-10',
    'Sterilization',
    'Castración rutinaria sin complicaciones',
    'Completed',
    '2024-02-01'
  ),
  (
    1,
    4,
    '2024-03-01',
    'Dental',
    'Limpieza dental con extracción de premolar',
    'Scheduled',
    '2024-02-10'
  ),
  (
    6,
    3,
    '2024-02-20',
    'Emergency',
    'Obstrucción intestinal',
    'Completed',
    '2024-02-15'
  );
-- Insertar servicios en cirugías
INSERT INTO "surgery_services" ("surgery_id", "service_id")
VALUES (1, 7),
  (2, 9),
  (3, 8);